<!DOCTYPE html>

<html>
<head>
  <title>div.lisp</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="abcd.html">
                  abcd.lisp
                </a>
              
                
                <a class="source" href="boot.html">
                  boot.lisp
                </a>
              
                
                <a class="source" href="col.html">
                  col.lisp
                </a>
              
                
                <a class="source" href="div.html">
                  div.lisp
                </a>
              
                
                <a class="source" href="fft.html">
                  fft.lisp
                </a>
              
                
                <a class="source" href="lib.html">
                  lib.lisp
                </a>
              
                
                <a class="source" href="num.html">
                  num.lisp
                </a>
              
                
                <a class="source" href="sample.html">
                  sample.lisp
                </a>
              
                
                <a class="source" href="weather.html">
                  weather.lisp
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>div.lisp</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-name">load</span> <span class="hljs-string">"../src/boot"</span>)
(<span class="hljs-name">reload</span> <span class="hljs-string">"../src/lib"</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>;;;;;;;;;;;;;;;;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-name">defun</span> ranges1 (<span class="hljs-name">lst</span> <span class="hljs-symbol">&amp;key</span>  (<span class="hljs-name">n</span> <span class="hljs-number">20</span>) (<span class="hljs-name">epsilon</span> <span class="hljs-number">1</span>) (<span class="hljs-name">f</span> #'identity))
  (<span class="hljs-name">let</span> ((<span class="hljs-name">tmp</span>)
        (<span class="hljs-name">first</span>   (<span class="hljs-name">car</span> lst))
        (<span class="hljs-name">counter</span> n))
    (<span class="hljs-name">while</span> (<span class="hljs-name">and</span> lst (<span class="hljs-name">&gt;=</span> (<span class="hljs-name">decf</span> counter) <span class="hljs-number">0</span>))
      (<span class="hljs-name">push</span> (<span class="hljs-name">pop</span> lst) tmp))
    (<span class="hljs-name">while</span> (<span class="hljs-name">and</span> lst
                (<span class="hljs-name">let</span> ((<span class="hljs-name">first</span>    (<span class="hljs-name">funcall</span> f first))
                      (<span class="hljs-name">current</span>  (<span class="hljs-name">funcall</span> f (<span class="hljs-name">car</span> tmp)))
                      (<span class="hljs-name">next</span>     (<span class="hljs-name">funcall</span> f (<span class="hljs-name">car</span> lst))))
                  (<span class="hljs-name">or</span>
                   (<span class="hljs-name">&lt;</span> (<span class="hljs-name">-</span> current first) epsilon)
                   (<span class="hljs-name">eql</span> current next))))
      (<span class="hljs-name">push</span> (<span class="hljs-name">pop</span> lst) tmp))
    (<span class="hljs-name">cond</span> ((<span class="hljs-name">&lt;</span> (<span class="hljs-name">length</span> lst) n)  (<span class="hljs-name">while</span> lst
                                 (<span class="hljs-name">push</span> (<span class="hljs-name">pop</span> lst) tmp))
                               (<span class="hljs-name">list</span> tmp))
          (<span class="hljs-name">t</span> (<span class="hljs-name">cons</span> tmp
                   (<span class="hljs-name">ranges1</span> lst <span class="hljs-symbol">:n</span> n <span class="hljs-symbol">:epsilon</span> epsilon <span class="hljs-symbol">:f</span> f))))))

(<span class="hljs-name">defun</span> ranges (<span class="hljs-name">lst</span> <span class="hljs-symbol">&amp;key</span>  (<span class="hljs-name">n</span> <span class="hljs-number">20</span>) (<span class="hljs-name">epsilon</span> <span class="hljs-number">1</span>) (<span class="hljs-name">f</span> #'identity))
  (<span class="hljs-name">ranges1</span>
   (<span class="hljs-name">sort</span> lst #'(lambda (a b)  (&lt; (funcall f a) (funcall f b))))
   <span class="hljs-symbol">:n</span> n <span class="hljs-symbol">:epsilon</span> epsilon <span class="hljs-symbol">:f</span> f))</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-name">defun</span> superranges1 (<span class="hljs-name">arr</span> f epsilon <span class="hljs-symbol">&amp;aux</span> out)
  <span class="hljs-string">"split array at point that minimized expected value of sd"</span>
  (<span class="hljs-name">macrolet</span> ((<span class="hljs-name">at</span> (<span class="hljs-name">n</span> v) `(slot-value (aref arr ,n) ,v)))
    (<span class="hljs-name">labels</span>
        ((<span class="hljs-name">sd</span>  (<span class="hljs-name">b4</span> z)
           (<span class="hljs-name">*</span> (<span class="hljs-name">at</span> z 'sd)
              (<span class="hljs-name">/</span> (<span class="hljs-name">at</span> z 'n) (<span class="hljs-name">at</span> b4 'z))))                        
         (<span class="hljs-name">all</span> (<span class="hljs-name">lo</span> hi <span class="hljs-symbol">&amp;aux</span> (<span class="hljs-name">out</span> (<span class="hljs-name">make-instance</span> 'num)))
             (<span class="hljs-name">loop</span> for j from lo to hi do
                  (<span class="hljs-name">adds</span> out (<span class="hljs-name">aref</span> arr j) f)
                return out))
         (<span class="hljs-name">argmin</span> (<span class="hljs-name">lo</span> hi <span class="hljs-symbol">&amp;aux</span> cut (<span class="hljs-name">best</span> most-positive-fixnum))
           (<span class="hljs-name">if</span> (<span class="hljs-name">&lt;</span> lo hi)
               (<span class="hljs-name">let</span> ((<span class="hljs-name">b4</span> (<span class="hljs-name">all</span> lo hi)))
                 (<span class="hljs-name">loop</span> for j from lo to (<span class="hljs-number">1</span>- hi) do
                      (<span class="hljs-name">let*</span> ((<span class="hljs-name">l</span>   (<span class="hljs-name">all</span> <span class="hljs-number">0</span>      j))
                             (<span class="hljs-name">r</span>   (<span class="hljs-name">all</span> (<span class="hljs-number">1</span>+ j) hi))
                             (<span class="hljs-name">now</span> (<span class="hljs-name">+</span> (<span class="hljs-name">sd</span> b4 l) (<span class="hljs-name">sd</span> b4 r))))
                        (<span class="hljs-name">if</span> (<span class="hljs-name">&lt;</span> now best)
                            (<span class="hljs-name">if</span> (<span class="hljs-name">&gt;</span> (<span class="hljs-name">-</span> (<span class="hljs-name">at</span> r 'mu) (<span class="hljs-name">at</span> l 'mu))
                                   epsilon)
                                (<span class="hljs-name">setf</span> best now
                                      cut   j)))))))
           cut)
         (<span class="hljs-name">recurse</span> (<span class="hljs-name">lo</span> cut hi)
           (<span class="hljs-name">split</span> lo        cut)
           (<span class="hljs-name">split</span> (<span class="hljs-number">1</span>+ cut)  hi))
         (<span class="hljs-name">keep</span> (<span class="hljs-name">lo</span> hi)
           (<span class="hljs-name">push</span> (<span class="hljs-name">coerce</span> (<span class="hljs-name">subseq</span> arr lo hi) 'list)
                 out))
         (<span class="hljs-name">split</span> (<span class="hljs-name">lo</span> hi)
           (<span class="hljs-name">let</span> ((<span class="hljs-name">cut</span> (<span class="hljs-name">argmin</span> lo hi)))
             (<span class="hljs-name">if</span> cut
                 (<span class="hljs-name">recurse</span> lo cut hi)
                 (<span class="hljs-name">keep</span> lo hi)))))
      (<span class="hljs-name">split</span> <span class="hljs-number">0</span> (<span class="hljs-number">1</span>- (<span class="hljs-name">length</span> arr)))
      out)))

(<span class="hljs-name">defun</span> superranges (<span class="hljs-name">lst</span> <span class="hljs-symbol">&amp;key</span> (<span class="hljs-name">n</span> <span class="hljs-number">20</span>) (<span class="hljs-name">xepsilon</span> <span class="hljs-number">0</span>) (<span class="hljs-name">cohen</span> <span class="hljs-number">0.2</span>)
                          (<span class="hljs-name">x</span> #'first) (<span class="hljs-name">y</span> #'second))
  <span class="hljs-string">"Split x-values in ranges; combine ranges that do not alter y.
   Returns an array of array of numbers"</span>
  (<span class="hljs-name">let*</span> ((<span class="hljs-name">arr</span>      (<span class="hljs-name">l-&gt;a</span>
                    (<span class="hljs-name">ranges</span> lst <span class="hljs-symbol">:n</span> n <span class="hljs-symbol">:epsilon</span> xepsilon <span class="hljs-symbol">:f</span> x)))
         (<span class="hljs-name">yepsilon</span> (<span class="hljs-name">*</span> cohen
                      (<span class="hljs-name">slot-value</span> (<span class="hljs-name">num*</span> lst y) 'sd))))
    (<span class="hljs-name">superranges1</span> arr y yepsilon)))</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
